Index: app/src/main/java/com/example/myyoutube/FloatingActivity.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>package com.example.myyoutube;\r\nimport android.os.PowerManager;\r\n\r\nimport android.content.ActivityNotFoundException;\r\nimport android.content.DialogInterface;\r\nimport android.content.Intent;\r\nimport android.content.SharedPreferences;\r\nimport android.content.res.ColorStateList;\r\nimport android.graphics.PixelFormat;\r\nimport android.net.Uri;\r\nimport android.os.Bundle;\r\nimport android.os.Environment;\r\nimport android.os.Handler;\r\nimport android.app.DownloadManager;\r\nimport android.speech.RecognizerIntent;\r\nimport android.util.Log;\r\nimport android.view.Gravity;\r\nimport android.view.LayoutInflater;\r\nimport android.view.MotionEvent;\r\nimport android.view.View;\r\nimport android.view.ViewConfiguration;\r\nimport android.view.ViewGroup;\r\nimport android.view.WindowManager;\r\nimport android.webkit.CookieManager;\r\nimport android.webkit.ValueCallback;\r\nimport android.webkit.WebSettings;\r\nimport android.webkit.WebView;\r\nimport android.webkit.WebViewClient;\r\nimport android.widget.LinearLayout;\r\nimport android.widget.SeekBar;\r\nimport android.widget.Toast;\r\nimport android.widget.Button;\r\nimport androidx.appcompat.app.AlertDialog;\r\nimport androidx.appcompat.app.AppCompatActivity;\r\nimport android.graphics.Color;\r\n\r\nimport java.util.ArrayList;\r\n\r\npublic class FloatingActivity extends AppCompatActivity {\r\n    private LinearLayout linearLayout1;\r\n    private WebView webView;\r\n    private LinearLayout sizeControlLayout;\r\n    private SeekBar sizeSeekBar;\r\n    private boolean isSizeControlVisible = false;\r\n    private Button btnDownload;\r\n    private Button btnMove;\r\n\r\n    private WindowManager windowManager;\r\n    private WindowManager.LayoutParams params;\r\n    private float playbackSpeed = 1.0f; // Default playback speed\r\n\r\n     private int skipTime = 180; // Default skip time (3 minutes)\r\n    private boolean isLooping = false;\r\n    private Handler handler;\r\n\r\n    private static final int VOICE_SEARCH_REQUEST_CODE = 100;\r\n\r\n\r\n    private static final String PREFS_NAME = \"MyYouTubePrefs\";\r\n    private static final String PREF_URL = \"LastVideoUrl\";\r\n    private static final String TAG = \"FloatingActivity\";\r\n    private static final int STATIC_WIDTH = 370; // Static width in dp\r\n    private static final float DEFAULT_HEIGHT_PERCENT = 0.5f; // 40% of screen height\r\n\r\n    // Touch handling variables\r\n    private float initialTouchX;\r\n    private float initialTouchY;\r\n    private int initialWidth;\r\n    private int initialHeight;\r\n\r\n    @Override\r\n    protected void onCreate(Bundle savedInstanceState) {\r\n        super.onCreate(savedInstanceState);\r\n\r\n        // Initialize WindowManager and LayoutParams\r\n        windowManager = (WindowManager) getSystemService(WINDOW_SERVICE);\r\n        int screenHeight = getResources().getDisplayMetrics().heightPixels;\r\n\r\n        params = new WindowManager.LayoutParams(\r\n                (int) (STATIC_WIDTH * getResources().getDisplayMetrics().density),\r\n                (int) (screenHeight * DEFAULT_HEIGHT_PERCENT),\r\n                WindowManager.LayoutParams.TYPE_APPLICATION_OVERLAY,\r\n                WindowManager.LayoutParams.FLAG_NOT_TOUCH_MODAL | WindowManager.LayoutParams.FLAG_WATCH_OUTSIDE_TOUCH,\r\n                PixelFormat.TRANSLUCENT\r\n        );\r\n        params.gravity = Gravity.TOP | Gravity.START;\r\n        params.x = 0;\r\n        params.y = 100;\r\n\r\n        // Inflate the floating layout\r\n        LayoutInflater inflater = (LayoutInflater) getSystemService(LAYOUT_INFLATER_SERVICE);\r\n        View view = inflater.inflate(R.layout.activity_floating, null);\r\n        windowManager.addView(view, params);\r\n\r\n        // Initialize UI elements\r\n        linearLayout1 = view.findViewById(R.id.linearLayout1);\r\n        webView = view.findViewById(R.id.webView);\r\n        sizeControlLayout = view.findViewById(R.id.sizeControlLayout);\r\n        sizeSeekBar = view.findViewById(R.id.sizeSeekBar);\r\n        btnDownload = view.findViewById(R.id.btnDownload);\r\n        btnMove = view.findViewById(R.id.btnMove);\r\n\r\n        // Setup WebView\r\n        initializeWebView();\r\n        loadVideoUrlFromIntent();\r\n\r\n        // Setup size control\r\n        setupSizeControl();\r\n\r\n        // Set button click listeners\r\n        view.findViewById(R.id.btnClose).setOnClickListener(v -> {\r\n            windowManager.removeView(view);\r\n\r\n            finish();\r\n        });\r\n        view.findViewById(R.id.btnAction2).setOnClickListener(v -> skipThreeMinutes());\r\n        view.findViewById(R.id.btnSpeed).setOnClickListener(v -> showSpeedDialog());\r\n        view.findViewById(R.id.btnLoop).setOnClickListener(v -> toggleLooping());\r\n        view.findViewById(R.id.btnVoiceSearch1).setOnClickListener(v -> startVoiceSearch());\r\n        view.findViewById(R.id.btnDownload).setOnClickListener(v -> downloadCurrentVideo());\r\n\r\n        // Setup move button touch listener\r\n        btnMove.setVisibility(View.VISIBLE); // Make move button visible\r\n        btnMove.setOnTouchListener(new View.OnTouchListener() {\r\n            @Override\r\n            public boolean onTouch(View v, MotionEvent event) {\r\n                switch (event.getAction()) {\r\n                    case MotionEvent.ACTION_DOWN:\r\n                        initialTouchX = event.getRawX();\r\n                        initialTouchY = event.getRawY();\r\n                        btnMove.setBackgroundTintList(ColorStateList.valueOf(Color.RED));\r\n                        return true;\r\n\r\n                    case MotionEvent.ACTION_MOVE:\r\n                        float deltaX = event.getRawX() - initialTouchX;\r\n                        float deltaY = event.getRawY() - initialTouchY;\r\n\r\n                        params.x += deltaX;\r\n                        params.y += deltaY;\r\n\r\n                        windowManager.updateViewLayout(linearLayout1, params);\r\n\r\n                        initialTouchX = event.getRawX();\r\n                        initialTouchY = event.getRawY();\r\n                        return true;\r\n\r\n                    case MotionEvent.ACTION_UP:\r\n                        btnMove.setBackgroundTintList(ColorStateList.valueOf(Color.parseColor(\"#5F6060\")));\r\n                        return true;\r\n                }\r\n                return false;\r\n            }\r\n        });\r\n\r\n        // Start duration check\r\n        startDurationCheck();\r\n    }\r\n\r\n    @Override\r\n    protected void onNewIntent(Intent intent) {\r\n        super.onNewIntent(intent);\r\n        setIntent(intent);\r\n        // Reload video URL from new intent\r\n        loadVideoUrlFromIntent();\r\n    }\r\n\r\n    private void initializeWebView() {\r\n        WebSettings webSettings = webView.getSettings();\r\n        webSettings.setJavaScriptEnabled(true);\r\n        webSettings.setDomStorageEnabled(true);\r\n        webSettings.setMediaPlaybackRequiresUserGesture(false);\r\n        webSettings.setAllowContentAccess(true);\r\n        webSettings.setAllowFileAccess(true);\r\n        webSettings.setLoadsImagesAutomatically(true);\r\n        webSettings.setCacheMode(WebSettings.LOAD_CACHE_ELSE_NETWORK);\r\n        webSettings.setAppCacheEnabled(true);\r\n        webSettings.setAppCachePath(getCacheDir().getPath());\r\n\r\n        // Enable hardware acceleration\r\n        webView.setLayerType(View.LAYER_TYPE_HARDWARE, null);\r\n\r\n        CookieManager cookieManager = CookieManager.getInstance();\r\n        cookieManager.setAcceptCookie(true);\r\n        cookieManager.setAcceptThirdPartyCookies(webView, true);\r\n\r\n        webView.setWebViewClient(new WebViewClient() {\r\n            @Override\r\n            public void onPageFinished(WebView view, String url) {\r\n                super.onPageFinished(view, url);\r\n                // Inject JavaScript to keep video playing in background\r\n                webView.evaluateJavascript(\r\n                    \"javascript:(function() {\" +\r\n                    \"    var video = document.querySelector('video');\" +\r\n                    \"    if(video) {\" +\r\n                    \"        video.addEventListener('play', function() {\" +\r\n                    \"            video.setAttribute('keepalive', 'true');\" +\r\n                    \"        });\" +\r\n                    \"    }\" +\r\n                    \"})();\", null\r\n                );\r\n            }\r\n        });\r\n    }\r\n\r\n    private void loadVideoUrlFromIntent() {\r\n        String videoUrl = getIntent().getStringExtra(\"video_url\");\r\n        loadVideoInPlayer(videoUrl);\r\n    }\r\n\r\n    private void loadVideoInPlayer(String videoUrl) {\r\n        if (videoUrl != null && !videoUrl.isEmpty()) {\r\n            if (videoUrl.contains(\"googlevideo.com/videoplayback\")) {\r\n                // Extract title from URL parameters\r\n                String title = \"\";\r\n                if (videoUrl.contains(\"title=\")) {\r\n                    try {\r\n                        String[] params = videoUrl.split(\"&\");\r\n                        for (String param : params) {\r\n                            if (param.startsWith(\"title=\")) {\r\n                                title = param.substring(6).replace(\"+\", \" \");\r\n                                title = java.net.URLDecoder.decode(title, \"UTF-8\");\r\n                                break;\r\n                            }\r\n                        }\r\n                    } catch (Exception e) {\r\n                        title = \"Video\";\r\n                    }\r\n                }\r\n\r\n                // For direct video URLs, create a custom HTML page with video player\r\n                String customHtml = \"<html><body style='margin:0; padding:0; background:black;'>\" +\r\n                                  \"<div style='color:white; padding:10px; font-family:Arial;'>\" + title + \"</div>\" +\r\n                                  \"<video style='width:100%; height:calc(100% - 40px);' controls autoplay>\" +\r\n                                  \"<source src='\" + videoUrl + \"' type='video/mp4'>\" +\r\n                                  \"</video></body></html>\";\r\n                webView.loadData(customHtml, \"text/html\", \"UTF-8\");\r\n            } else {\r\n                webView.loadUrl(videoUrl);\r\n            }\r\n        } else {\r\n            webView.loadUrl(\"https://www.youtube.com\");\r\n        }\r\n    }\r\n\r\n    private void skipThreeMinutes() {\r\n        webView.evaluateJavascript(\"document.querySelector('video').currentTime += \" + skipTime + \";\", null);\r\n    }\r\n\r\n    private void startDurationCheck() {\r\n        if (handler == null) {\r\n            handler = new Handler();\r\n        }\r\n        handler.postDelayed(new Runnable() {\r\n            @Override\r\n            public void run() {\r\n                checkAndSkipAds();\r\n                skipVideo();\r\n                handler.postDelayed(this, 1000);\r\n            }\r\n        }, 1000);\r\n    }\r\n\r\n    private void checkAndSkipAds() {\r\n        // Check and skip ads (if applicable)\r\n        webView.evaluateJavascript(\"javascript:(function() {\" +\r\n                \"const skipButton = document.querySelector('button[class*=\\\"ytp-ad-skip-button\\\"]');\" +\r\n                \"if (skipButton) {\" +\r\n                \"skipButton.click();\" + // Clicking the skip ad button\r\n                \"const video = document.querySelector('video');\" +\r\n                \"if (video) {\" +\r\n                \"video.currentTime += 1900; \" + // Skip forward by 40 seconds\r\n                \"return 'Реклама пропущена, видео перемотано на 1900 секунд';\" +\r\n                \"} else {\" +\r\n                \"return 'Видео не найдено, но реклама пропущена';\" +\r\n                \"}\" +\r\n                \"} else {\" +\r\n                \"return 'Кнопка пропуска рекламы не найдена';\" +\r\n                \"}\" +\r\n                \"})();\", value -> {\r\n            if (value != null && !value.equals(\"null\")) {\r\n\r\n            }\r\n        });\r\n    }\r\n\r\n    private void skipVideo() {\r\n        webView.evaluateJavascript(\r\n                \"(function() {\" +\r\n                        \"var video = document.querySelector('video');\" +\r\n                        \"if (video) {\" +\r\n                        \"return video.duration;\" +\r\n                        \"} else {\" +\r\n                        \"return 0;\" +\r\n                        \"}\" +\r\n                        \"})();\", new ValueCallback<String>() {\r\n                    @Override\r\n                    public void onReceiveValue(String value) {\r\n                        try {\r\n                            double duration = Double.parseDouble(value);\r\n                            if (duration < 25) { // If video is shorter than 4 seconds\r\n                                // Skip forward 3 minutes (180 seconds)\r\n                                webView.evaluateJavascript(\r\n                                        \"var video = document.querySelector('video');\" +\r\n                                                \"if (video) {\" +\r\n                                                \"var newTime = video.currentTime + 180;\" + // Skip forward 3 minutes\r\n                                                \"if (newTime < video.duration) {\" +\r\n                                                \"video.currentTime = newTime;\" +\r\n                                                \"} else {\" +\r\n                                                \"video.currentTime = video.duration;\" +\r\n                                                \"}\" +\r\n                                                \"}\", null);\r\n                            } else {\r\n\r\n                            }\r\n                        } catch (NumberFormatException e) {\r\n                            Log.e(TAG, \"Error parsing video duration: \" + e.getMessage());\r\n                        }\r\n                    }\r\n                });\r\n    }\r\n\r\n    private void showSpeedDialog() {\r\n        // Cycle through the speeds: 1x -> 2x -> 3x -> 1x\r\n        if (playbackSpeed == 1.0f) {\r\n            playbackSpeed = 2.0f; // Change to 2x\r\n        } else if (playbackSpeed == 2.0f) {\r\n            playbackSpeed = 3.0f; // Change to 3x\r\n        } else {\r\n            playbackSpeed = 1.0f; // Change back to 1x\r\n        }\r\n\r\n        applyPlaybackSpeed(playbackSpeed);\r\n    }\r\n\r\n    private void applyPlaybackSpeed(float speed) {\r\n        webView.evaluateJavascript(\"document.querySelector('video').playbackRate = \" + speed + \";\", null);\r\n    }\r\n\r\n    private void toggleLooping() {\r\n        // Toggle the looping state\r\n        isLooping = !isLooping;\r\n\r\n        // Execute JavaScript to toggle the loop property of the video element\r\n        webView.evaluateJavascript(\"document.querySelector('video').loop = \" + isLooping + \";\", null);\r\n    }\r\n\r\n    private void startVoiceSearch() {\r\n        Intent intent = new Intent(RecognizerIntent.ACTION_RECOGNIZE_SPEECH);\r\n        intent.putExtra(RecognizerIntent.EXTRA_LANGUAGE_MODEL, RecognizerIntent.LANGUAGE_MODEL_FREE_FORM);\r\n        intent.putExtra(RecognizerIntent.EXTRA_PROMPT, \"Say something to search on YouTube\");\r\n\r\n        try {\r\n            startActivityForResult(intent, VOICE_SEARCH_REQUEST_CODE);\r\n        } catch (ActivityNotFoundException e) {\r\n            Toast.makeText(this, \"Speech recognition is not supported on this device\", Toast.LENGTH_SHORT).show();\r\n        }\r\n    }\r\n\r\n    @Override\r\n    protected void onActivityResult(int requestCode, int resultCode, Intent data) {\r\n        super.onActivityResult(requestCode, resultCode, data);\r\n\r\n        if (requestCode == VOICE_SEARCH_REQUEST_CODE && resultCode == RESULT_OK && data != null) {\r\n            ArrayList<String> results = data.getStringArrayListExtra(RecognizerIntent.EXTRA_RESULTS);\r\n            if (results != null && !results.isEmpty()) {\r\n                openYouTubeSearch(results.get(0));\r\n            } else {\r\n                Toast.makeText(this, \"No voice input detected\", Toast.LENGTH_SHORT).show();\r\n            }\r\n        }\r\n    }\r\n\r\n    private void openYouTubeSearch(String query) {\r\n        String searchUrl = \"https://www.youtube.com/results?search_query=\" + query.replace(\" \", \"+\");\r\n        webView.loadUrl(searchUrl);\r\n    }\r\n\r\n    private void setupSizeControl() {\r\n        int screenHeight = getResources().getDisplayMetrics().heightPixels;\r\n\r\n        sizeSeekBar.setOnSeekBarChangeListener(new SeekBar.OnSeekBarChangeListener() {\r\n            @Override\r\n            public void onProgressChanged(SeekBar seekBar, int progress, boolean fromUser) {\r\n                if (fromUser) {\r\n                    float scale = Math.max(0.05f, progress / 100f);\r\n                    params.height = (int) (screenHeight * scale);\r\n                    \r\n                    // Update only the window layout\r\n                    windowManager.updateViewLayout(linearLayout1, params);\r\n                }\r\n            }\r\n\r\n            @Override\r\n            public void onStartTrackingTouch(SeekBar seekBar) {}\r\n\r\n            @Override\r\n            public void onStopTrackingTouch(SeekBar seekBar) {}\r\n        });\r\n    }\r\n\r\n\r\n\r\n\r\n    @Override\r\n    public void onBackPressed() {\r\n        // Start MainActivity and finish this activity\r\n        Intent intent = new Intent(this, MainActivity.class);\r\n        intent.addFlags(Intent.FLAG_ACTIVITY_SINGLE_TOP | Intent.FLAG_ACTIVITY_CLEAR_TOP);\r\n        startActivity(intent);\r\n        finish();\r\n    }\r\n\r\n    private void downloadCurrentVideo() {\r\n        String currentUrl = getIntent().getStringExtra(\"video_url\");\r\n\r\n        if (currentUrl != null && currentUrl.contains(\"googlevideo.com/videoplayback\")) {\r\n            loadVideoInPlayer(currentUrl);\r\n            Toast.makeText(this, \"Loading video...\", Toast.LENGTH_SHORT).show();\r\n        } else {\r\n            try {\r\n                // Encode the video URL\r\n                String encodedUrl = java.net.URLEncoder.encode(currentUrl, \"UTF-8\");\r\n\r\n                // Construct the SaveFrom.net URL with the video link\r\n                String saveFromUrl = \"https://uk.savefrom.net/1-youtube-video-downloader.html?url=\" + encodedUrl;\r\n\r\n                // Open the URL in the browser\r\n                Intent intent = new Intent(Intent.ACTION_VIEW, Uri.parse(saveFromUrl));\r\n                startActivity(intent);\r\n\r\n                Toast.makeText(this, \"Opening SaveFrom.net in the browser...\", Toast.LENGTH_SHORT).show();\r\n            } catch (Exception e) {\r\n                Toast.makeText(this, \"Error opening URL: \" + e.getMessage(), Toast.LENGTH_SHORT).show();\r\n            }\r\n        }\r\n    }\r\n\r\n    @Override\r\n    protected void onPause() {\r\n        super.onPause();\r\n        // Pause the video when the activity is not visible\r\n        webView.evaluateJavascript(\"document.querySelector('video').pause();\", null);\r\n    }\r\n\r\n    @Override\r\n    protected void onResume() {\r\n        super.onResume();\r\n        // Resume the video when the activity is visible\r\n        webView.evaluateJavascript(\"document.querySelector('video').play();\", null);\r\n    }\r\n\r\n}\r\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/src/main/java/com/example/myyoutube/FloatingActivity.java b/app/src/main/java/com/example/myyoutube/FloatingActivity.java
--- a/app/src/main/java/com/example/myyoutube/FloatingActivity.java	
+++ b/app/src/main/java/com/example/myyoutube/FloatingActivity.java	
@@ -166,15 +166,6 @@
 
     private void initializeWebView() {
         WebSettings webSettings = webView.getSettings();
-        webSettings.setJavaScriptEnabled(true);
-        webSettings.setDomStorageEnabled(true);
-        webSettings.setMediaPlaybackRequiresUserGesture(false);
-        webSettings.setAllowContentAccess(true);
-        webSettings.setAllowFileAccess(true);
-        webSettings.setLoadsImagesAutomatically(true);
-        webSettings.setCacheMode(WebSettings.LOAD_CACHE_ELSE_NETWORK);
-        webSettings.setAppCacheEnabled(true);
-        webSettings.setAppCachePath(getCacheDir().getPath());
 
         // Enable hardware acceleration
         webView.setLayerType(View.LAYER_TYPE_HARDWARE, null);
